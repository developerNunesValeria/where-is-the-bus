import { asyncScheduler, EMPTY, merge, Subject } from 'rxjs';
import { distinctUntilChanged, map, switchMap, takeUntil, tap } from 'rxjs/operators';
import { isWithinBounds } from './common';
export class Scrollbar {
    constructor(cmp, platform, document, zone) {
        this.cmp = cmp;
        this.platform = platform;
        this.document = document;
        this.zone = zone;
        // Stream that emits to unsubscribe from all streams
        this.destroyed = new Subject();
    }
    /**
     * Activate scrollbar pointer events
     */
    activatePointerEvents() {
        // Stream that emits when scrollbar thumb is dragged
        let thumbDragEvent = EMPTY;
        // Stream that emits when scrollbar track is clicked
        let trackClickEvent = EMPTY;
        // Stream that emits when scrollbar track is hovered
        let trackHoveredEvent = EMPTY;
        // Set the method used for the pointer events option
        if (this.cmp.pointerEventsMethod === 'viewport') {
            // Pointer events using the viewport
            this.viewportTrackClicked = new Subject();
            this.viewportThumbClicked = new Subject();
            // Activate the pointer events of the viewport directive
            this.cmp.viewport.activatePointerEvents(this.cmp.viewportPropagateMouseMove, this.destroyed);
            // Set streams
            thumbDragEvent = this.viewportThumbClicked;
            trackClickEvent = this.viewportTrackClicked;
            trackHoveredEvent = this.cmp.viewport.hovered.pipe(
            // Check if track is hovered
            map((e) => isWithinBounds(e, this.track.clientRect)), distinctUntilChanged(), 
            // Enable / disable text selection
            tap((hovered) => this.document.onselectstart = hovered ? () => false : null));
            this.cmp.viewport.clicked.pipe(tap((e) => {
                if (e) {
                    if (isWithinBounds(e, this.thumb.clientRect)) {
                        this.viewportThumbClicked.next(e);
                    }
                    else if (isWithinBounds(e, this.track.clientRect)) {
                        this.cmp.setClicked(true);
                        this.viewportTrackClicked.next(e);
                    }
                }
                else {
                    this.cmp.setClicked(false);
                }
            }), takeUntil(this.destroyed)).subscribe();
        }
        else {
            // Pointer events method is using 'scrollbar'
            thumbDragEvent = this.thumb.clicked;
            trackClickEvent = this.track.clicked;
            trackHoveredEvent = this.track.hovered;
        }
        return merge(
        // Activate scrollbar hovered event
        trackHoveredEvent.pipe(tap((e) => this.setHovered(e))), 
        // Activate scrollbar thumb drag event
        thumbDragEvent.pipe(switchMap((e) => this.thumb.dragged(e))), 
        // Activate scrollbar track click event
        trackClickEvent.pipe(switchMap((e) => this.track.onTrackClicked(e, this.thumb.size, this.viewportScrollSize))));
    }
    ngOnInit() {
        this.zone.runOutsideAngular(() => {
            // Activate pointer events on Desktop only
            if (!(this.platform.IOS || this.platform.ANDROID) && !this.cmp.pointerEventsDisabled) {
                this.activatePointerEvents().pipe(takeUntil(this.destroyed)).subscribe();
            }
            // Stream that emits when host component is updated
            const updated = this.cmp.updated.pipe(tap(() => this.onUpdated()));
            // Update scrollbar thumb when viewport is scrolled and when scrollbar component is updated
            merge(this.cmp.scrolled, updated).pipe(tap(() => this.thumb.update()), takeUntil(this.destroyed)).subscribe();
            // Initialize scrollbar
            asyncScheduler.schedule(() => this.thumb.update(), 100);
        });
    }
    ngOnDestroy() {
        this.destroyed.next();
        this.destroyed.complete();
        // Clean up viewport streams if used
        if (this.viewportThumbClicked && this.viewportTrackClicked) {
            this.viewportTrackClicked.complete();
            this.viewportThumbClicked.complete();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXNjcm9sbGJhci8iLCJzb3VyY2VzIjpbImxpYi9zY3JvbGxiYXIvc2Nyb2xsYmFyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxjQUFjLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDekUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSXRGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFMUMsTUFBTSxPQUFnQixTQUFTO0lBa0I3QixZQUE2QixHQUFnQixFQUFZLFFBQWtCLEVBQVksUUFBYSxFQUFZLElBQVk7UUFBL0YsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUFZLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBWSxhQUFRLEdBQVIsUUFBUSxDQUFLO1FBQVksU0FBSSxHQUFKLElBQUksQ0FBUTtRQVo1SCxvREFBb0Q7UUFDakMsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFZbkQsQ0FBQztJQUVEOztPQUVHO0lBQ0sscUJBQXFCO1FBQzNCLG9EQUFvRDtRQUNwRCxJQUFJLGNBQWMsR0FBb0IsS0FBSyxDQUFDO1FBQzVDLG9EQUFvRDtRQUNwRCxJQUFJLGVBQWUsR0FBb0IsS0FBSyxDQUFDO1FBQzdDLG9EQUFvRDtRQUNwRCxJQUFJLGlCQUFpQixHQUFvQixLQUFLLENBQUM7UUFFL0Msb0RBQW9EO1FBQ3BELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsS0FBSyxVQUFVLEVBQUU7WUFDL0Msb0NBQW9DO1lBQ3BDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1lBQy9DLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1lB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Q0FBQztZQUNyQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDdEM7SUFDSCxDQUFDO0NBS0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPbkRlc3Ryb3ksIE9uSW5pdCwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBQbGF0Zm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wbGF0Zm9ybSc7XG5pbXBvcnQgeyBhc3luY1NjaGVkdWxlciwgRU1QVFksIG1lcmdlLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBzd2l0Y2hNYXAsIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTmdTY3JvbGxiYXIgfSBmcm9tICcuLi9uZy1zY3JvbGxiYXInO1xuaW1wb3J0IHsgVGh1bWJBZGFwdGVyIH0gZnJvbSAnLi90aHVtYi90aHVtYic7XG5pbXBvcnQgeyBUcmFja0FkYXB0ZXIgfSBmcm9tICcuL3RyYWNrL3RyYWNrJztcbmltcG9ydCB7IGlzV2l0aGluQm91bmRzIH0gZnJvbSAnLi9jb21tb24nO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2Nyb2xsYmFyIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gIC8vIFRodW1iIGRpcmVjdGl2ZSByZWZlcmVuY2VcbiAgcmVhZG9ubHkgdGh1bWI6IFRodW1iQWRhcHRlcjtcbiAgLy8gVHJhY2sgZGlyZWN0aXZlIHJlZmVyZW5jZVxuICByZWFkb25seSB0cmFjazogVHJhY2tBZGFwdGVyO1xuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB0byB1bnN1YnNjcmliZSBmcm9tIGFsbCBzdHJlYW1zXG4gIHByb3RlY3RlZCByZWFkb25seSBkZXN0cm95ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIC8qKlxuICAgKiBWaWV3cG9ydCBwb2ludGVyIGV2ZW50c1xuICAgKiBUaGUgZm9sbG93aW5nIHN0cmVhbXMgYXJlIG9ubHkgYWN0aXZhdGVkIHdoZW4gKHBvaW50ZXJFdmVudHNNZXRob2QgPT09ICd2aWV3cG9ydCcpXG4gICAqL1xuICBwcm90ZWN0ZWQgdmlld3BvcnRUcmFja0NsaWNrZWQhOiBTdWJqZWN0PGFueT47XG4gIHByb3RlY3RlZCB2aWV3cG9ydFRodW1iQ2xpY2tlZCE6IFN1YmplY3Q8YW55PjtcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHZpZXdwb3J0U2Nyb2xsU2l6ZSgpOiBudW1iZXI7XG5cbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHB1YmxpYyBjbXA6IE5nU2Nyb2xsYmFyLCBwcm90ZWN0ZWQgcGxhdGZvcm06IFBsYXRmb3JtLCBwcm90ZWN0ZWQgZG9jdW1lbnQ6IGFueSwgcHJvdGVjdGVkIHpvbmU6IE5nWm9uZSkge1xuICB9XG5cbiAgLyoqXG4gICAqIEFjdGl2YXRlIHNjcm9sbGJhciBwb2ludGVyIGV2ZW50c1xuICAgKi9cbiAgcHJpdmF0ZSBhY3RpdmF0ZVBvaW50ZXJFdmVudHMoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0aHVtYiBpcyBkcmFnZ2VkXG4gICAgbGV0IHRodW1iRHJhZ0V2ZW50OiBPYnNlcnZhYmxlPGFueT4gPSBFTVBUWTtcbiAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0cmFjayBpcyBjbGlja2VkXG4gICAgbGV0IHRyYWNrQ2xpY2tFdmVudDogT2JzZXJ2YWJsZTxhbnk+ID0gRU1QVFk7XG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdHJhY2sgaXMgaG92ZXJlZFxuICAgIGxldCB0cmFja0hvdmVyZWRFdmVudDogT2JzZXJ2YWJsZTxhbnk+ID0gRU1QVFk7XG5cbiAgICAvLyBTZXQgdGhlIG1ldGhvZCB1c2VkIGZvciB0aGUgcG9pbnRlciBldmVudHMgb3B0aW9uXG4gICAgaWYgKHRoaXMuY21wLnBvaW50ZXJFdmVudHNNZXRob2QgPT09ICd2aWV3cG9ydCcpIHtcbiAgICAgIC8vIFBvaW50ZXIgZXZlbnRzIHVzaW5nIHRoZSB2aWV3cG9ydFxuICAgICAgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICAgIHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG5cbiAgICAgIC8vIEFjdGl2YXRlIHRoZSBwb2ludGVyIGV2ZW50cyBvZiB0aGUgdmlld3BvcnQgZGlyZWN0aXZlXG4gICAgICB0aGlzLmNtcC52aWV3cG9ydC5hY3RpdmF0ZVBvaW50ZXJFdmVudHModGhpcy5jbXAudmlld3BvcnRQcm9wYWdhdGVNb3VzZU1vdmUsIHRoaXMuZGVzdHJveWVkKTtcblxuICAgICAgLy8gU2V0IHN0cmVhbXNcbiAgICAgIHRodW1iRHJhZ0V2ZW50ID0gdGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZDtcbiAgICAgIHRyYWNrQ2xpY2tFdmVudCA9IHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQ7XG4gICAgICB0cmFja0hvdmVyZWRFdmVudCA9IHRoaXMuY21wLnZpZXdwb3J0LmhvdmVyZWQucGlwZShcbiAgICAgICAgLy8gQ2hlY2sgaWYgdHJhY2sgaXMgaG92ZXJlZFxuICAgICAgICBtYXAoKGU6IGFueSkgPT4gaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50cmFjay5jbGllbnRSZWN0KSksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgIC8vIEVuYWJsZSAvIGRpc2FibGUgdGV4dCBzZWxlY3Rpb25cbiAgICAgICAgdGFwKChob3ZlcmVkOiBib29sZWFuKSA9PiB0aGlzLmRvY3VtZW50Lm9uc2VsZWN0c3RhcnQgPSBob3ZlcmVkID8gKCkgPT4gZmFsc2UgOiBudWxsKVxuICAgICAgKTtcblxuICAgICAgdGhpcy5jbXAudmlld3BvcnQuY2xpY2tlZC5waXBlKFxuICAgICAgICB0YXAoKGU6IGFueSkgPT4ge1xuICAgICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgICBpZiAoaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50aHVtYi5jbGllbnRSZWN0KSkge1xuICAgICAgICAgICAgICB0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkLm5leHQoZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2l0aGluQm91bmRzKGUsIHRoaXMudHJhY2suY2xpZW50UmVjdCkpIHtcbiAgICAgICAgICAgICAgdGhpcy5jbXAuc2V0Q2xpY2tlZCh0cnVlKTtcbiAgICAgICAgICAgICAgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZC5uZXh0KGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNtcC5zZXRDbGlja2VkKGZhbHNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpXG4gICAgICApLnN1YnNjcmliZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBQb2ludGVyIGV2ZW50cyBtZXRob2QgaXMgdXNpbmcgJ3Njcm9sbGJhcidcbiAgICAgIHRodW1iRHJhZ0V2ZW50ID0gdGhpcy50aHVtYi5jbGlja2VkO1xuICAgICAgdHJhY2tDbGlja0V2ZW50ID0gdGhpcy50cmFjay5jbGlja2VkO1xuICAgICAgdHJhY2tIb3ZlcmVkRXZlbnQgPSB0aGlzLnRyYWNrLmhvdmVyZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1lcmdlKFxuICAgICAgLy8gQWN0aXZhdGUgc2Nyb2xsYmFyIGhvdmVyZWQgZXZlbnRcbiAgICAgIHRyYWNrSG92ZXJlZEV2ZW50LnBpcGUodGFwKChlOiBib29sZWFuKSA9PiB0aGlzLnNldEhvdmVyZWQoZSkpKSxcbiAgICAgIC8vIEFjdGl2YXRlIHNjcm9sbGJhciB0aHVtYiBkcmFnIGV2ZW50XG4gICAgICB0aHVtYkRyYWdFdmVudC5waXBlKHN3aXRjaE1hcCgoZTogYW55KSA9PiB0aGlzLnRodW1iLmRyYWdnZWQoZSkpKSxcbiAgICAgIC8vIEFjdGl2YXRlIHNjcm9sbGJhciB0cmFjayBjbGljayBldmVudFxuICAgICAgdHJhY2tDbGlja0V2ZW50LnBpcGUoc3dpdGNoTWFwKChlOiBhbnkpID0+IHRoaXMudHJhY2sub25UcmFja0NsaWNrZWQoZSwgdGhpcy50aHVtYi5zaXplLCB0aGlzLnZpZXdwb3J0U2Nyb2xsU2l6ZSkpKVxuICAgICk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgLy8gQWN0aXZhdGUgcG9pbnRlciBldmVudHMgb24gRGVza3RvcCBvbmx5XG4gICAgICBpZiAoISh0aGlzLnBsYXRmb3JtLklPUyB8fCB0aGlzLnBsYXRmb3JtLkFORFJPSUQpICYmICF0aGlzLmNtcC5wb2ludGVyRXZlbnRzRGlzYWJsZWQpIHtcbiAgICAgICAgdGhpcy5hY3RpdmF0ZVBvaW50ZXJFdmVudHMoKS5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCkpLnN1YnNjcmliZSgpO1xuICAgICAgfVxuXG4gICAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGhvc3QgY29tcG9uZW50IGlzIHVwZGF0ZWRcbiAgICAgIGNvbnN0IHVwZGF0ZWQgPSB0aGlzLmNtcC51cGRhdGVkLnBpcGUodGFwKCgpID0+IHRoaXMub25VcGRhdGVkKCkpKTtcblxuICAgICAgLy8gVXBkYXRlIHNjcm9sbGJhciB0aHVtYiB3aGVuIHZpZXdwb3J0IGlzIHNjcm9sbGVkIGFuZCB3aGVuIHNjcm9sbGJhciBjb21wb25lbnQgaXMgdXBkYXRlZFxuICAgICAgbWVyZ2UodGhpcy5jbXAuc2Nyb2xsZWQsIHVwZGF0ZWQpLnBpcGUoXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLnRodW1iLnVwZGF0ZSgpKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKVxuICAgICAgKS5zdWJzY3JpYmUoKTtcblxuICAgICAgLy8gSW5pdGlhbGl6ZSBzY3JvbGxiYXJcbiAgICAgIGFzeW5jU2NoZWR1bGVyLnNjaGVkdWxlKCgpID0+IHRoaXMudGh1bWIudXBkYXRlKCksIDEwMCk7XG4gICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3llZC5uZXh0KCk7XG4gICAgdGhpcy5kZXN0cm95ZWQuY29tcGxldGUoKTtcblxuICAgIC8vIENsZWFuIHVwIHZpZXdwb3J0IHN0cmVhbXMgaWYgdXNlZFxuICAgIGlmICh0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkICYmIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQpIHtcbiAgICAgIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQuY29tcGxldGUoKTtcbiAgICAgIHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQuY29tcGxldGUoKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2V0SG92ZXJlZCh2YWx1ZTogYm9vbGVhbik6IHZvaWQ7XG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IG9uVXBkYXRlZCgpOiB2b2lkO1xufVxuIl19