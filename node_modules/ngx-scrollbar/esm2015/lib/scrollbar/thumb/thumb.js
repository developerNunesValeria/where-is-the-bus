import { __decorate, __metadata } from "tslib";
import { Input, Output } from '@angular/core';
import { animationFrameScheduler, of, fromEvent, Subject } from 'rxjs';
import { distinctUntilChanged, map, mergeMap, pluck, takeUntil, tap } from 'rxjs/operators';
import { enableSelection, preventSelection, stopPropagation } from '../common';
import { TrackAdapter } from '../track/track';
export class ThumbAdapter {
    constructor(cmp, thumbElement, document) {
        this.cmp = cmp;
        this.thumbElement = thumbElement;
        this.document = document;
        // Stream that emits dragging state
        this._dragging = new Subject();
        this.dragging = this._dragging.pipe(distinctUntilChanged());
    }
    get trackMax() {
        return this.track.size - this.size;
    }
    // Get thumb client rect
    get clientRect() {
        return this.thumbElement.getBoundingClientRect();
    }
    // Stream that emits when scrollbar thumb is clicked
    get clicked() {
        return fromEvent(this.thumbElement, 'mousedown', { passive: true }).pipe(stopPropagation());
    }
    // Calculate and update thumb position and size
    update() {
        const size = calculateThumbSize(this.track.size, this.viewportScrollSize, this.cmp.minThumbSize);
        const position = calculateThumbPosition(this.viewportScrollOffset, this.viewportScrollMax, this.trackMax);
        animationFrameScheduler.schedule(() => this.updateStyles(this.handleDirection(position, this.trackMax), size));
    }
    /**
     * Stream that emits the 'scrollTo' position when a scrollbar thumb element is dragged
     * This function is called by thumb drag event using viewport or scrollbar pointer events
     */
    dragged(event) {
        let trackMaxStart;
        let scrollMaxStart;
        const dragStart = of(event).pipe(preventSelection(this.document), tap(() => {
            // Capture scrollMax and trackMax once
            trackMaxStart = this.trackMax;
            scrollMaxStart = this.viewportScrollMax;
            this.setDragging(true);
        }));
        const dragging = fromEvent(this.document, 'mousemove', { capture: true, passive: true }).pipe(stopPropagation());
        const dragEnd = fromEvent(this.document, 'mouseup', { capture: true }).pipe(stopPropagation(), enableSelection(this.document), tap(() => this.setDragging(false)));
        return dragStart.pipe(pluck(this.pageProperty), map((pageOffset) => pageOffset - this.dragStartOffset), mergeMap((mouseDownOffset) => dragging.pipe(pluck(this.clientProperty), 
        // Calculate how far the pointer is from the top/left of the scrollbar (minus the dragOffset).
        map((mouseOffset) => mouseOffset - this.track.offset), map((offset) => scrollMaxStart * (offset - mouseDownOffset) / trackMaxStart), map((position) => this.handleDrag(position, scrollMaxStart)), tap((position) => this.scrollTo(position)), takeUntil(dragEnd))));
    }
}
__decorate([
    Input(),
    __metadata("design:type", TrackAdapter)
], ThumbAdapter.prototype, "track", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], ThumbAdapter.prototype, "dragging", void 0);
/**
 * Calculate scrollbar thumb size
 */
function calculateThumbSize(trackSize, contentSize, minThumbSize) {
    const scrollbarRatio = trackSize / contentSize;
    const thumbSize = scrollbarRatio * trackSize;
    return Math.max(~~thumbSize, minThumbSize);
}
/**
 * Calculate scrollbar thumb position
 */
function calculateThumbPosition(scrollPosition, scrollMax, trackMax) {
    return scrollPosition * trackMax / scrollMax;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGh1bWIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtc2Nyb2xsYmFyLyIsInNvdXJjZXMiOlsibGliL3Njcm9sbGJhci90aHVtYi90aHVtYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUMsT0FBTyxFQUFFLHVCQUF1QixFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25GLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFL0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTlDLE1BQU0sT0FBZ0IsWUFBWTtJQXVDaEMsWUFBZ0MsR0FBZ0IsRUFDaEIsWUFBeUIsRUFDekIsUUFBYTtRQUZiLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFDaEIsaUJBQVksR0FBWixZQUFZLENBQWE7UUFDekIsYUFBUSxHQUFSLFFBQVEsQ0FBSztRQXJDN0MsbUNBQW1DO1FBQzNCLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBVyxDQUFDO1FBQ2pDLGFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUM7SUFvQ2pFLENBQUM7SUFqQkQsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3JDLENBQUM7SUFFRCx3QkFBd0I7SUFDeEIsSUFBSSxVQUFVO1FBQ1osT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDbkQsQ0FB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QUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUNsRCxTQUFTLENBQUMsT0FBTyxDQUFDLENBQ25CLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztDQWdCRjtBQXhHVTtJQUFSLEtBQUssRUFBRTs4QkFBUSxZQUFZOzJDQUFDO0FBSW5CO0lBQVQsTUFBTSxFQUFFOzs4Q0FBd0Q7QUFzR25FOztHQUVHO0FBQ0gsU0FBUyxrQkFBa0IsQ0FBQyxTQUFpQixFQUFFLFdBQW1CLEVBQUUsWUFBb0I7SUFDdEYsTUFBTSxjQUFjLEdBQUcsU0FBUyxHQUFHLFdBQVcsQ0FBQztJQUMvQyxNQUFNLFNBQVMsR0FBRyxjQUFjLEdBQUcsU0FBUyxDQUFDO0lBQzdDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsc0JBQXNCLENBQUMsY0FBc0IsRUFBRSxTQUFpQixFQUFFLFFBQWdCO0lBQ3pGLE9BQU8sY0FBYyxHQUFHLFFBQVEsR0FBRyxTQUFTLENBQUM7QUFDL0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElucHV0LCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGFuaW1hdGlvbkZyYW1lU2NoZWR1bGVyLCBvZiwgZnJvbUV2ZW50LCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBtZXJnZU1hcCwgcGx1Y2ssIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgZW5hYmxlU2VsZWN0aW9uLCBwcmV2ZW50U2VsZWN0aW9uLCBzdG9wUHJvcGFnYXRpb24gfSBmcm9tICcuLi9jb21tb24nO1xuaW1wb3J0IHsgTmdTY3JvbGxiYXIgfSBmcm9tICcuLi8uLi9uZy1zY3JvbGxiYXInO1xuaW1wb3J0IHsgVHJhY2tBZGFwdGVyIH0gZnJvbSAnLi4vdHJhY2svdHJhY2snO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVGh1bWJBZGFwdGVyIHtcblxuICBASW5wdXQoKSB0cmFjazogVHJhY2tBZGFwdGVyO1xuXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIGRyYWdnaW5nIHN0YXRlXG4gIHByaXZhdGUgX2RyYWdnaW5nID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgQE91dHB1dCgpIGRyYWdnaW5nID0gdGhpcy5fZHJhZ2dpbmcucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcblxuICAvLyBSZXR1cm5zIGVpdGhlciAncGFnZVgnIG9yICdwYWdlWScgYWNjb3JkaW5nIHRvIHNjcm9sbGJhciBheGlzXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgcGFnZVByb3BlcnR5KCk6IHN0cmluZztcblxuICAvLyBSZXR1cm5zIGVpdGhlciAnY2xpZW50SGVpZ2h0JyBvciAnY2xpZW50V2lkdGgnIGFjY29yZGluZyB0byBzY3JvbGxiYXIgYXhpc1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IGNsaWVudFByb3BlcnR5KCk6IHN0cmluZztcblxuICBhYnN0cmFjdCBnZXQgZHJhZ1N0YXJ0T2Zmc2V0KCk6IG51bWJlcjtcblxuICAvLyBSZXR1cm5zIHRodW1iIHNpemUsIGNsaWVudEhlaWdodCBvciBjbGllbnRXaWR0aFxuICBhYnN0cmFjdCBnZXQgc2l6ZSgpOiBudW1iZXI7XG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCB2aWV3cG9ydFNjcm9sbFNpemUoKTogbnVtYmVyO1xuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgdmlld3BvcnRTY3JvbGxPZmZzZXQoKTogbnVtYmVyO1xuXG4gIGFic3RyYWN0IGdldCB2aWV3cG9ydFNjcm9sbE1heCgpOiBudW1iZXI7XG5cbiAgZ2V0IHRyYWNrTWF4KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMudHJhY2suc2l6ZSAtIHRoaXMuc2l6ZTtcbiAgfVxuXG4gIC8vIEdldCB0aHVtYiBjbGllbnQgcmVjdFxuICBnZXQgY2xpZW50UmVjdCgpOiBDbGllbnRSZWN0IHtcbiAgICByZXR1cm4gdGhpcy50aHVtYkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gIH1cblxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0aHVtYiBpcyBjbGlja2VkXG4gIGdldCBjbGlja2VkKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIGZyb21FdmVudCh0aGlzLnRodW1iRWxlbWVudCwgJ21vdXNlZG93bicsIHsgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKHN0b3BQcm9wYWdhdGlvbigpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgY21wOiBOZ1Njcm9sbGJhcixcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCB0aHVtYkVsZW1lbnQ6IEhUTUxFbGVtZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdGVjdGVkIGRvY3VtZW50OiBhbnkpIHtcbiAgfVxuXG4gIC8vIENhbGN1bGF0ZSBhbmQgdXBkYXRlIHRodW1iIHBvc2l0aW9uIGFuZCBzaXplXG4gIHVwZGF0ZSgpIHtcbiAgICBjb25zdCBzaXplID0gY2FsY3VsYXRlVGh1bWJTaXplKHRoaXMudHJhY2suc2l6ZSwgdGhpcy52aWV3cG9ydFNjcm9sbFNpemUsIHRoaXMuY21wLm1pblRodW1iU2l6ZSEpO1xuICAgIGNvbnN0IHBvc2l0aW9uID0gY2FsY3VsYXRlVGh1bWJQb3NpdGlvbih0aGlzLnZpZXdwb3J0U2Nyb2xsT2Zmc2V0LCB0aGlzLnZpZXdwb3J0U2Nyb2xsTWF4LCB0aGlzLnRyYWNrTWF4KTtcbiAgICBhbmltYXRpb25GcmFtZVNjaGVkdWxlci5zY2hlZHVsZSgoKSA9PiB0aGlzLnVwZGF0ZVN0eWxlcyh0aGlzLmhhbmRsZURpcmVjdGlvbihwb3NpdGlvbiwgdGhpcy50cmFja01heCksIHNpemUpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdHJlYW0gdGhhdCBlbWl0cyB0aGUgJ3Njcm9sbFRvJyBwb3NpdGlvbiB3aGVuIGEgc2Nyb2xsYmFyIHRodW1iIGVsZW1lbnQgaXMgZHJhZ2dlZFxuICAgKiBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBieSB0aHVtYiBkcmFnIGV2ZW50IHVzaW5nIHZpZXdwb3J0IG9yIHNjcm9sbGJhciBwb2ludGVyIGV2ZW50c1xuICAgKi9cbiAgZHJhZ2dlZChldmVudDogYW55KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICBsZXQgdHJhY2tNYXhTdGFydDogbnVtYmVyO1xuICAgIGxldCBzY3JvbGxNYXhTdGFydDogbnVtYmVyO1xuXG4gICAgY29uc3QgZHJhZ1N0YXJ0ID0gb2YoZXZlbnQpLnBpcGUoXG4gICAgICBwcmV2ZW50U2VsZWN0aW9uKHRoaXMuZG9jdW1lbnQpLFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgLy8gQ2FwdHVyZSBzY3JvbGxNYXggYW5kIHRyYWNrTWF4IG9uY2VcbiAgICAgICAgdHJhY2tNYXhTdGFydCA9IHRoaXMudHJhY2tNYXg7XG4gICAgICAgIHNjcm9sbE1heFN0YXJ0ID0gdGhpcy52aWV3cG9ydFNjcm9sbE1heDtcbiAgICAgICAgdGhpcy5zZXREcmFnZ2luZyh0cnVlKTtcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBjb25zdCBkcmFnZ2luZyA9IGZyb21FdmVudCh0aGlzLmRvY3VtZW50LCAnbW91c2Vtb3ZlJywgeyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH0pLnBpcGUoc3RvcFByb3BhZ2F0aW9uKCkpO1xuXG4gICAgY29uc3QgZHJhZ0VuZCA9IGZyb21FdmVudCh0aGlzLmRvY3VtZW50LCAnbW91c2V1cCcsIHsgY2FwdHVyZTogdHJ1ZSB9KS5waXBlKFxuICAgICAgc3RvcFByb3BhZ2F0aW9uKCksXG4gICAgICBlbmFibGVTZWxlY3Rpb24odGhpcy5kb2N1bWVudCksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5zZXREcmFnZ2luZyhmYWxzZSkpXG4gICAgKTtcblxuICAgIHJldHVybiBkcmFnU3RhcnQucGlwZShcbiAgICAgIHBsdWNrKHRoaXMucGFnZVByb3BlcnR5KSxcbiAgICAgIG1hcCgocGFnZU9mZnNldDogbnVtYmVyKSA9PiBwYWdlT2Zmc2V0IC0gdGhpcy5kcmFnU3RhcnRPZmZzZXQpLFxuICAgICAgbWVyZ2VNYXAoKG1vdXNlRG93bk9mZnNldDogbnVtYmVyKSA9PiBkcmFnZ2luZy5waXBlKFxuICAgICAgICBwbHVjayh0aGlzLmNsaWVudFByb3BlcnR5KSxcbiAgICAgICAgLy8gQ2FsY3VsYXRlIGhvdyBmYXIgdGhlIHBvaW50ZXIgaXMgZnJvbSB0aGUgdG9wL2xlZnQgb2YgdGhlIHNjcm9sbGJhciAobWludXMgdGhlIGRyYWdPZmZzZXQpLlxuICAgICAgICBtYXAoKG1vdXNlT2Zmc2V0OiBudW1iZXIpID0+IG1vdXNlT2Zmc2V0IC0gdGhpcy50cmFjay5vZmZzZXQpLFxuICAgICAgICBtYXAoKG9mZnNldDogbnVtYmVyKSA9PiBzY3JvbGxNYXhTdGFydCAqIChvZmZzZXQgLSBtb3VzZURvd25PZmZzZXQpIC8gdHJhY2tNYXhTdGFydCksXG4gICAgICAgIG1hcCgocG9zaXRpb246IG51bWJlcikgPT4gdGhpcy5oYW5kbGVEcmFnKHBvc2l0aW9uLCBzY3JvbGxNYXhTdGFydCkpLFxuICAgICAgICB0YXAoKHBvc2l0aW9uOiBudW1iZXIpID0+IHRoaXMuc2Nyb2xsVG8ocG9zaXRpb24pKSxcbiAgICAgICAgdGFrZVVudGlsKGRyYWdFbmQpXG4gICAgICApKVxuICAgICk7XG4gIH1cblxuICAvLyBTZXQgZHJhZ2dpbmcgc3RhdGVcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHNldERyYWdnaW5nKHZhbHVlOiBib29sZWFuKTogdm9pZDtcblxuICAvLyBTY3JvbGwgdmlld3BvcnQgaW5zdGFudGx5XG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzY3JvbGxUbyhwb3NpdGlvbjogbnVtYmVyKTogdm9pZDtcblxuICAvLyBVcGRhdGUgdGh1bWIgZWxlbWVudCBzaXplIGFuZCBwb3NpdGlvblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgdXBkYXRlU3R5bGVzKHBvc2l0aW9uOiBudW1iZXIsIHNpemU6IG51bWJlcik6IHZvaWQ7XG5cbiAgLy8gSGFuZGxlIGRyYWdnaW5nIHBvc2l0aW9uIChTdXBwb3J0IExUUiBhbmQgUlRMIGRpcmVjdGlvbnMgZm9yIHRoZSBob3Jpem9udGFsIHNjcm9sbGJhcilcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGhhbmRsZURyYWcocG9zaXRpb246IG51bWJlciwgc2Nyb2xsTWF4PzogbnVtYmVyKTogbnVtYmVyO1xuXG4gIC8vIEhhbmRsZSBzY3JvbGxpbmcgcG9zaXRpb24gKFN1cHBvcnQgTFRSIGFuZCBSVEwgZGlyZWN0aW9ucyBmb3IgdGhlIGhvcml6b250YWwgc2Nyb2xsYmFyKVxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgaGFuZGxlRGlyZWN0aW9uKHBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heD86IG51bWJlcik6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDYWxjdWxhdGUgc2Nyb2xsYmFyIHRodW1iIHNpemVcbiAqL1xuZnVuY3Rpb24gY2FsY3VsYXRlVGh1bWJTaXplKHRyYWNrU2l6ZTogbnVtYmVyLCBjb250ZW50U2l6ZTogbnVtYmVyLCBtaW5UaHVtYlNpemU6IG51bWJlcik6IG51bWJlciB7XG4gIGNvbnN0IHNjcm9sbGJhclJhdGlvID0gdHJhY2tTaXplIC8gY29udGVudFNpemU7XG4gIGNvbnN0IHRodW1iU2l6ZSA9IHNjcm9sbGJhclJhdGlvICogdHJhY2tTaXplO1xuICByZXR1cm4gTWF0aC5tYXgofn50aHVtYlNpemUsIG1pblRodW1iU2l6ZSk7XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlIHNjcm9sbGJhciB0aHVtYiBwb3NpdGlvblxuICovXG5mdW5jdGlvbiBjYWxjdWxhdGVUaHVtYlBvc2l0aW9uKHNjcm9sbFBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heDogbnVtYmVyLCB0cmFja01heDogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIHNjcm9sbFBvc2l0aW9uICogdHJhY2tNYXggLyBzY3JvbGxNYXg7XG59XG4iXX0=