import { __decorate, __metadata, __param } from "tslib";
import { Directive, Input, Injectable, Inject, AfterContentInit, OnDestroy, NgZone, Output, EventEmitter } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { Platform } from '@angular/cdk/platform';
import { coerceBooleanProperty, coerceNumberProperty } from '@angular/cdk/coercion';
import { from, of, EMPTY, BehaviorSubject, Observable } from 'rxjs';
import { catchError, debounceTime, map, switchMap } from 'rxjs/operators';
import { NgScrollbar } from '../ng-scrollbar';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "@angular/cdk/platform";
/**
 * Factory that initialize the ResizeObserver if available in the browser
 * Otherwise, it lazy-loads the ResizeObserver polyfill
 */
var ResizeObserverFactory = /** @class */ (function () {
    function ResizeObserverFactory(document, platform) {
        this.resizeObserverSource = new BehaviorSubject(null);
        this.resizeObserverLoader = this.resizeObserverSource.asObservable();
        if (platform.isBrowser) {
            var resizeObserverApi = document.defaultView.ResizeObserver
                ? of(document.defaultView.ResizeObserver)
                : from(import('@juggle/resize-observer')).pipe(map(function (module) { return module.ResizeObserver; }), catchError(function (e) {
                    console.log('Unable to load ResizeObserver polyfill', e);
                    return EMPTY;
                }));
            this.resizeObserverSource.next(resizeObserverApi);
        }
    }
    ResizeObserverFactory.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
        { type: Platform }
    ]; };
    ResizeObserverFactory.ɵprov = i0.ɵɵdefineInjectable({ factory: function ResizeObserverFactory_Factory() { return new ResizeObserverFactory(i0.ɵɵinject(i1.DOCUMENT), i0.ɵɵinject(i2.Platform)); }, token: ResizeObserverFactory, providedIn: "root" });
    ResizeObserverFactory = __decorate([
        Injectable({ providedIn: 'root' }),
        __param(0, Inject(DOCUMENT)),
        __metadata("design:paramtypes", [Object, Platform])
    ], ResizeObserverFactory);
    return ResizeObserverFactory;
}());
export { ResizeObserverFactory };
var ResizeSensor = /** @class */ (function () {
    function ResizeSensor(zone, platform, resizeObserverFactory, scrollbar) {
        this.zone = zone;
        this.platform = platform;
        this.resizeObserverFactory = resizeObserverFactory;
        this.scrollbar = scrollbar;
        this._disabled = false;
        this._subscription = null;
        this.resizeSensor = new EventEmitter();
        if (!scrollbar) {
            throw new Error('[NgScrollbar Resize Sensor Directive]: Host element must be an NgScrollbar component.');
        }
    }
    Object.defineProperty(ResizeSensor.prototype, "debounce", {
        /** Debounce interval for emitting the changes. */
        get: function () {
            return this._debounce;
        },
        set: function (value) {
            this._debounce = coerceNumberProperty(value);
            this._subscribe();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ResizeSensor.prototype, "disabled", {
        /** Whether ResizeObserver is disabled. */
        get: function () {
            return this._disabled;
        },
        set: function (value) {
            this._disabled = coerceBooleanProperty(value);
            this._disabled ? this._unsubscribe() : this._subscribe();
        },
        enumerable: true,
        configurable: true
    });
    ResizeSensor.prototype.ngAfterContentInit = function () {
        if (!this._subscription && !this._disabled) {
            this._subscribe();
        }
    };
    ResizeSensor.prototype.ngOnDestroy = function () {
        this._unsubscribe();
    };
    ResizeSensor.prototype._createObserver = function (ResizeObserver) {
        var _this = this;
        return new Observable(function (observer) {
            _this._resizeObserver = new ResizeObserver(function () { return observer.next(); });
            _this._resizeObserver.observe(_this.scrollbar.viewport.nativeElement);
            if (_this.scrollbar.viewport.contentWrapperElement) {
                _this._resizeObserver.observe(_this.scrollbar.viewport.contentWrapperElement);
            }
        });
    };
    ResizeSensor.prototype._subscribe = function () {
        var _this = this;
        this._unsubscribe();
        if (this.platform.isBrowser) {
            this.zone.runOutsideAngular(function () {
                _this._subscription = _this.resizeObserverFactory.resizeObserverLoader.pipe(switchMap(function (moduleObservable) { return moduleObservable; }), switchMap(function (ResizeObserver) {
                    if (ResizeObserver) {
                        var stream = _this._createObserver(ResizeObserver);
                        return _this.debounce ? stream.pipe(debounceTime(_this._debounce)) : stream;
                    }
                    else {
                        return EMPTY;
                    }
                })).subscribe(function () { return _this.resizeSensor.emit(); });
            });
        }
    };
    ResizeSensor.prototype._unsubscribe = function () {
        if (this._resizeObserver) {
            this._resizeObserver.disconnect();
        }
        if (this._subscription) {
            this._subscription.unsubscribe();
        }
    };
    ResizeSensor.ctorParameters = function () { return [
        { type: NgZone },
        { type: Platform },
        { type: ResizeObserverFactory },
        { type: NgScrollbar }
    ]; };
    __decorate([
        Input('sensorDebounce'),
        __metadata("design:type", Number),
        __metadata("design:paramtypes", [Number])
    ], ResizeSensor.prototype, "debounce", null);
    __decorate([
        Input('sensorDisabled'),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], ResizeSensor.prototype, "disabled", null);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], ResizeSensor.prototype, "resizeSensor", void 0);
    ResizeSensor = __decorate([
        Directive({ selector: '[resizeSensor]' }),
        __metadata("design:paramtypes", [NgZone,
            Platform,
            ResizeObserverFactory,
            NgScrollbar])
    ], ResizeSensor);
    return ResizeSensor;
}());
export { ResizeSensor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzaXplLXNlbnNvci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtc2Nyb2xsYmFyLyIsInNvdXJjZXMiOlsibGliL3V0aWxzL3Jlc2l6ZS1zZW5zb3IuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoSSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2pELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3BGLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsVUFBVSxFQUEwQixNQUFNLE1BQU0sQ0FBQztBQUM1RixPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7O0FBRTlDOzs7R0FHRztBQUVIO0lBSUUsK0JBQThCLFFBQWEsRUFBRSxRQUFrQjtRQUg5Qyx5QkFBb0IsR0FBRyxJQUFJLGVBQWUsQ0FBTSxJQUFJLENBQUMsQ0FBQztRQUM5RCx5QkFBb0IsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWSxFQUFFLENBQUM7UUFHdkUsSUFBSSxRQUFRLENBQUMsU0FBUyxFQUFFO1lBQ3RCLElBQU0saUJBQWlCLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxjQUFjO2dCQUMzRCxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMs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U0FDbkM7UUFDRCxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNsQztJQUNILENBQUM7O2dCQXZEeUIsTUFBTTtnQkFDRixRQUFRO2dCQUNLLHFCQUFxQjtnQkFDakMsV0FBVzs7SUFoQzFDO1FBREMsS0FBSyxDQUFDLGdCQUFnQixDQUFDOzs7Z0RBR3ZCO0lBV0Q7UUFEQyxLQUFLLENBQUMsZ0JBQWdCLENBQUM7OztnREFHdkI7SUFZUztRQUFULE1BQU0sRUFBRTs7c0RBQXlDO0lBL0J2QyxZQUFZO1FBRHhCLFNBQVMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxnQkFBZ0IsRUFBRSxDQUFDO3lDQWtDZCxNQUFNO1lBQ0YsUUFBUTtZQUNLLHFCQUFxQjtZQUNqQyxXQUFXO09BcEMvQixZQUFZLENBeUZ4QjtJQUFELG1CQUFDO0NBQUEsQUF6RkQsSUF5RkM7U0F6RlksWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5wdXQsIEluamVjdGFibGUsIEluamVjdCwgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95LCBOZ1pvbmUsIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBQbGF0Zm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wbGF0Zm9ybSc7XG5pbXBvcnQgeyBjb2VyY2VCb29sZWFuUHJvcGVydHksIGNvZXJjZU51bWJlclByb3BlcnR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcbmltcG9ydCB7IGZyb20sIG9mLCBFTVBUWSwgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIE9ic2VydmVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBkZWJvdW5jZVRpbWUsIG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTmdTY3JvbGxiYXIgfSBmcm9tICcuLi9uZy1zY3JvbGxiYXInO1xuXG4vKipcbiAqIEZhY3RvcnkgdGhhdCBpbml0aWFsaXplIHRoZSBSZXNpemVPYnNlcnZlciBpZiBhdmFpbGFibGUgaW4gdGhlIGJyb3dzZXJcbiAqIE90aGVyd2lzZSwgaXQgbGF6eS1sb2FkcyB0aGUgUmVzaXplT2JzZXJ2ZXIgcG9seWZpbGxcbiAqL1xuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBSZXNpemVPYnNlcnZlckZhY3Rvcnkge1xuICBwcml2YXRlIHJlYWRvbmx5IHJlc2l6ZU9ic2VydmVyU291cmNlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxhbnk+KG51bGwpO1xuICByZWFkb25seSByZXNpemVPYnNlcnZlckxvYWRlciA9IHRoaXMucmVzaXplT2JzZXJ2ZXJTb3VyY2UuYXNPYnNlcnZhYmxlKCk7XG5cbiAgY29uc3RydWN0b3IoQEluamVjdChET0NVTUVOVCkgZG9jdW1lbnQ6IGFueSwgcGxhdGZvcm06IFBsYXRmb3JtKSB7XG4gICAgaWYgKHBsYXRmb3JtLmlzQnJvd3Nlcikge1xuICAgICAgY29uc3QgcmVzaXplT2JzZXJ2ZXJBcGkgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5SZXNpemVPYnNlcnZlclxuICAgICAgICA/IG9mKGRvY3VtZW50LmRlZmF1bHRWaWV3LlJlc2l6ZU9ic2VydmVyKVxuICAgICAgICA6IGZyb20oaW1wb3J0KCdAanVnZ2xlL3Jlc2l6ZS1vYnNlcnZlcicpKS5waXBlKFxuICAgICAgICAgIG1hcCgobW9kdWxlOiB7IFJlc2l6ZU9ic2VydmVyOiBhbnkgfSkgPT4gbW9kdWxlLlJlc2l6ZU9ic2VydmVyKSxcbiAgICAgICAgICBjYXRjaEVycm9yKChlKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnVW5hYmxlIHRvIGxvYWQgUmVzaXplT2JzZXJ2ZXIgcG9seWZpbGwnLCBlKTtcbiAgICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgICB9KSk7XG4gICAgICB0aGlzLnJlc2l6ZU9ic2VydmVyU291cmNlLm5leHQocmVzaXplT2JzZXJ2ZXJBcGkpO1xuICAgIH1cbiAgfVxufVxuXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbcmVzaXplU2Vuc29yXScgfSlcbmV4cG9ydCBjbGFzcyBSZXNpemVTZW5zb3IgaW1wbGVtZW50cyBBZnRlckNvbnRlbnRJbml0LCBPbkRlc3Ryb3kge1xuXG4gIC8qKiBEZWJvdW5jZSBpbnRlcnZhbCBmb3IgZW1pdHRpbmcgdGhlIGNoYW5nZXMuICovXG4gIEBJbnB1dCgnc2Vuc29yRGVib3VuY2UnKVxuICBnZXQgZGVib3VuY2UoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fZGVib3VuY2U7XG4gIH1cblxuICBzZXQgZGVib3VuY2UodmFsdWU6IG51bWJlcikge1xuICAgIHRoaXMuX2RlYm91bmNlID0gY29lcmNlTnVtYmVyUHJvcGVydHkodmFsdWUpO1xuICAgIHRoaXMuX3N1YnNjcmliZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZGVib3VuY2U6IG51bWJlcjtcblxuICAvKiogV2hldGhlciBSZXNpemVPYnNlcnZlciBpcyBkaXNhYmxlZC4gKi9cbiAgQElucHV0KCdzZW5zb3JEaXNhYmxlZCcpXG4gIGdldCBkaXNhYmxlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5fZGlzYWJsZWQ7XG4gIH1cblxuICBzZXQgZGlzYWJsZWQodmFsdWU6IGFueSkge1xuICAgIHRoaXMuX2Rpc2FibGVkID0gY29lcmNlQm9vbGVhblByb3BlcnR5KHZhbHVlKTtcbiAgICB0aGlzLl9kaXNhYmxlZCA/IHRoaXMuX3Vuc3Vic2NyaWJlKCkgOiB0aGlzLl9zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgX2Rpc2FibGVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgcHJpdmF0ZSBfc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBfcmVzaXplT2JzZXJ2ZXI6IGFueTtcblxuICBAT3V0cHV0KCkgcmVzaXplU2Vuc29yID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgem9uZTogTmdab25lLFxuICAgICAgICAgICAgICBwcml2YXRlIHBsYXRmb3JtOiBQbGF0Zm9ybSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSByZXNpemVPYnNlcnZlckZhY3Rvcnk6IFJlc2l6ZU9ic2VydmVyRmFjdG9yeSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBzY3JvbGxiYXI6IE5nU2Nyb2xsYmFyKSB7XG4gICAgaWYgKCFzY3JvbGxiYXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignW05nU2Nyb2xsYmFyIFJlc2l6ZSBTZW5zb3IgRGlyZWN0aXZlXTogSG9zdCBlbGVtZW50IG11c3QgYmUgYW4gTmdTY3JvbGxiYXIgY29tcG9uZW50LicpO1xuICAgIH1cbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcbiAgICBpZiAoIXRoaXMuX3N1YnNjcmlwdGlvbiAmJiAhdGhpcy5fZGlzYWJsZWQpIHtcbiAgICAgIHRoaXMuX3N1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuX3Vuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwcml2YXRlIF9jcmVhdGVPYnNlcnZlcihSZXNpemVPYnNlcnZlcjogYW55KTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKChvYnNlcnZlcjogT2JzZXJ2ZXI8dm9pZD4pID0+IHtcbiAgICAgIHRoaXMuX3Jlc2l6ZU9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKCgpID0+IG9ic2VydmVyLm5leHQoKSk7XG4gICAgICB0aGlzLl9yZXNpemVPYnNlcnZlci5vYnNlcnZlKHRoaXMuc2Nyb2xsYmFyLnZpZXdwb3J0Lm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgaWYgKHRoaXMuc2Nyb2xsYmFyLnZpZXdwb3J0LmNvbnRlbnRXcmFwcGVyRWxlbWVudCkge1xuICAgICAgICB0aGlzLl9yZXNpemVPYnNlcnZlci5vYnNlcnZlKHRoaXMuc2Nyb2xsYmFyLnZpZXdwb3J0LmNvbnRlbnRXcmFwcGVyRWxlbWVudCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9zdWJzY3JpYmUoKSB7XG4gICAgdGhpcy5fdW5zdWJzY3JpYmUoKTtcbiAgICBpZiAodGhpcy5wbGF0Zm9ybS5pc0Jyb3dzZXIpIHtcbiAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbiA9IHRoaXMucmVzaXplT2JzZXJ2ZXJGYWN0b3J5LnJlc2l6ZU9ic2VydmVyTG9hZGVyLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChtb2R1bGVPYnNlcnZhYmxlOiBPYnNlcnZhYmxlPGFueT4pID0+IG1vZHVsZU9ic2VydmFibGUpLFxuICAgICAgICAgIHN3aXRjaE1hcCgoUmVzaXplT2JzZXJ2ZXI6IGFueSkgPT4ge1xuICAgICAgICAgICAgaWYgKFJlc2l6ZU9ic2VydmVyKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHN0cmVhbSA9IHRoaXMuX2NyZWF0ZU9ic2VydmVyKFJlc2l6ZU9ic2VydmVyKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGVib3VuY2UgPyBzdHJlYW0ucGlwZShkZWJvdW5jZVRpbWUodGhpcy5fZGVib3VuY2UpKSA6IHN0cmVhbTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICApLnN1YnNjcmliZSgoKSA9PiB0aGlzLnJlc2l6ZVNlbnNvci5lbWl0KCkpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfdW5zdWJzY3JpYmUoKSB7XG4gICAgaWYgKHRoaXMuX3Jlc2l6ZU9ic2VydmVyKSB7XG4gICAgICB0aGlzLl9yZXNpemVPYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9zdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxufVxuIl19