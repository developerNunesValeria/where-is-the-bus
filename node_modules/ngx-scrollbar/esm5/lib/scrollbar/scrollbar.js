import { asyncScheduler, EMPTY, merge, Subject } from 'rxjs';
import { distinctUntilChanged, map, switchMap, takeUntil, tap } from 'rxjs/operators';
import { isWithinBounds } from './common';
var Scrollbar = /** @class */ (function () {
    function Scrollbar(cmp, platform, document, zone) {
        this.cmp = cmp;
        this.platform = platform;
        this.document = document;
        this.zone = zone;
        // Stream that emits to unsubscribe from all streams
        this.destroyed = new Subject();
    }
    /**
     * Activate scrollbar pointer events
     */
    Scrollbar.prototype.activatePointerEvents = function () {
        var _this = this;
        // Stream that emits when scrollbar thumb is dragged
        var thumbDragEvent = EMPTY;
        // Stream that emits when scrollbar track is clicked
        var trackClickEvent = EMPTY;
        // Stream that emits when scrollbar track is hovered
        var trackHoveredEvent = EMPTY;
        // Set the method used for the pointer events option
        if (this.cmp.pointerEventsMethod === 'viewport') {
            // Pointer events using the viewport
            this.viewportTrackClicked = new Subject();
            this.viewportThumbClicked = new Subject();
            // Activate the pointer events of the viewport directive
            this.cmp.viewport.activatePointerEvents(this.cmp.viewportPropagateMouseMove, this.destroyed);
            // Set streams
            thumbDragEvent = this.viewportThumbClicked;
            trackClickEvent = this.viewportTrackClicked;
            trackHoveredEvent = this.cmp.viewport.hovered.pipe(
            // Check if track is hovered
            map(function (e) { return isWithinBounds(e, _this.track.clientRect); }), distinctUntilChanged(), 
            // Enable / disable text selection
            tap(function (hovered) { return _this.document.onselectstart = hovered ? function () { return false; } : null; }));
            this.cmp.viewport.clicked.pipe(tap(function (e) {
                if (e) {
                    if (isWithinBounds(e, _this.thumb.clientRect)) {
                        _this.viewportThumbClicked.next(e);
                    }
                    else if (isWithinBounds(e, _this.track.clientRect)) {
                        _this.cmp.setClicked(true);
                        _this.viewportTrackClicked.next(e);
                    }
                }
                else {
                    _this.cmp.setClicked(false);
                }
            }), takeUntil(this.destroyed)).subscribe();
        }
        else {
            // Pointer events method is using 'scrollbar'
            thumbDragEvent = this.thumb.clicked;
            trackClickEvent = this.track.clicked;
            trackHoveredEvent = this.track.hovered;
        }
        return merge(
        // Activate scrollbar hovered event
        trackHoveredEvent.pipe(tap(function (e) { return _this.setHovered(e); })), 
        // Activate scrollbar thumb drag event
        thumbDragEvent.pipe(switchMap(function (e) { return _this.thumb.dragged(e); })), 
        // Activate scrollbar track click event
        trackClickEvent.pipe(switchMap(function (e) { return _this.track.onTrackClicked(e, _this.thumb.size, _this.viewportScrollSize); })));
    };
    Scrollbar.prototype.ngOnInit = function () {
        var _this = this;
        this.zone.runOutsideAngular(function () {
            // Activate pointer events on Desktop only
            if (!(_this.platform.IOS || _this.platform.ANDROID) && !_this.cmp.pointerEventsDisabled) {
                _this.activatePointerEvents().pipe(takeUntil(_this.destroyed)).subscribe();
            }
            // Stream that emits when host component is updated
            var updated = _this.cmp.updated.pipe(tap(function () { return _this.onUpdated(); }));
            // Update scrollbar thumb when viewport is scrolled and when scrollbar component is updated
            merge(_this.cmp.scrolled, updated).pipe(tap(function () { return _this.thumb.update(); }), takeUntil(_this.destroyed)).subscribe();
            // Initialize scrollbar
            asyncScheduler.schedule(function () { return _this.thumb.update(); }, 100);
        });
    };
    Scrollbar.prototype.ngOnDestroy = function () {
        this.destroyed.next();
        this.destroyed.complete();
        // Clean up viewport streams if used
        if (this.viewportThumbClicked && this.viewportTrackClicked) {
            this.viewportTrackClicked.complete();
            this.viewportThumbClicked.complete();
        }
    };
    return Scrollbar;
}());
export { Scrollbar };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXNjcm9sbGJhci8iLCJzb3VyY2VzIjpbImxpYi9zY3JvbGxiYXIvc2Nyb2xsYmFyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxjQUFjLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDekUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSXRGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFMUM7SUFrQkUsbUJBQTZCLEdBQWdCLEVBQVksUUFBa0IsRUFBWSxRQUFhLEVBQVksSUFBWTtRQUEvRixRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQVksYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFZLGFBQVEsR0FBUixRQUFRLENBQUs7UUFBWSxTQUFJLEdBQUosSUFBSSxDQUFRO1FBWjVILG9EQUFvRDtRQUNqQyxjQUFTLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztJQVluRCxDQUFDO0lBRUQ7O09BRUc7SUFDSyx5Q0FBcUIsR0FBN0I7UUFBQSxpQkEwREM7UUF6REMsb0RBQW9EO1FBQ3BELElBQUksY0FBYyxHQUFvQixLQUFLLENBQUM7UUFDNUMsb0RBQW9EO1FBQ3BELElBQUksZUFBZSxHQUFvQixLQUFLLENBQUM7UUFDN0Msb0RBQW9EO1FBQ3BELElBQUksaUJBQWlCLEdBQW9CLEtBQUssQ0FBQztRQUUvQyxvREFBb0Q7UUFDcEQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixLQUFLLFVBQVUsRUFBRTtZQUMvQyxvQ0FBb0M7WUFDcEMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7WUFDL0MsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7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b0IsSUFBSSxJQUFJLENBQUMsb0JBQW9CLEVBQUU7WUFDMUQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3JDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUN0QztJQUNILENBQUM7SUFLSCxnQkFBQztBQUFELENBQUMsQUF2SEQsSUF1SEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPbkRlc3Ryb3ksIE9uSW5pdCwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBQbGF0Zm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wbGF0Zm9ybSc7XG5pbXBvcnQgeyBhc3luY1NjaGVkdWxlciwgRU1QVFksIG1lcmdlLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBzd2l0Y2hNYXAsIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTmdTY3JvbGxiYXIgfSBmcm9tICcuLi9uZy1zY3JvbGxiYXInO1xuaW1wb3J0IHsgVGh1bWJBZGFwdGVyIH0gZnJvbSAnLi90aHVtYi90aHVtYic7XG5pbXBvcnQgeyBUcmFja0FkYXB0ZXIgfSBmcm9tICcuL3RyYWNrL3RyYWNrJztcbmltcG9ydCB7IGlzV2l0aGluQm91bmRzIH0gZnJvbSAnLi9jb21tb24nO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2Nyb2xsYmFyIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gIC8vIFRodW1iIGRpcmVjdGl2ZSByZWZlcmVuY2VcbiAgcmVhZG9ubHkgdGh1bWI6IFRodW1iQWRhcHRlcjtcbiAgLy8gVHJhY2sgZGlyZWN0aXZlIHJlZmVyZW5jZVxuICByZWFkb25seSB0cmFjazogVHJhY2tBZGFwdGVyO1xuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB0byB1bnN1YnNjcmliZSBmcm9tIGFsbCBzdHJlYW1zXG4gIHByb3RlY3RlZCByZWFkb25seSBkZXN0cm95ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIC8qKlxuICAgKiBWaWV3cG9ydCBwb2ludGVyIGV2ZW50c1xuICAgKiBUaGUgZm9sbG93aW5nIHN0cmVhbXMgYXJlIG9ubHkgYWN0aXZhdGVkIHdoZW4gKHBvaW50ZXJFdmVudHNNZXRob2QgPT09ICd2aWV3cG9ydCcpXG4gICAqL1xuICBwcm90ZWN0ZWQgdmlld3BvcnRUcmFja0NsaWNrZWQhOiBTdWJqZWN0PGFueT47XG4gIHByb3RlY3RlZCB2aWV3cG9ydFRodW1iQ2xpY2tlZCE6IFN1YmplY3Q8YW55PjtcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHZpZXdwb3J0U2Nyb2xsU2l6ZSgpOiBudW1iZXI7XG5cbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHB1YmxpYyBjbXA6IE5nU2Nyb2xsYmFyLCBwcm90ZWN0ZWQgcGxhdGZvcm06IFBsYXRmb3JtLCBwcm90ZWN0ZWQgZG9jdW1lbnQ6IGFueSwgcHJvdGVjdGVkIHpvbmU6IE5nWm9uZSkge1xuICB9XG5cbiAgLyoqXG4gICAqIEFjdGl2YXRlIHNjcm9sbGJhciBwb2ludGVyIGV2ZW50c1xuICAgKi9cbiAgcHJpdmF0ZSBhY3RpdmF0ZVBvaW50ZXJFdmVudHMoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0aHVtYiBpcyBkcmFnZ2VkXG4gICAgbGV0IHRodW1iRHJhZ0V2ZW50OiBPYnNlcnZhYmxlPGFueT4gPSBFTVBUWTtcbiAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0cmFjayBpcyBjbGlja2VkXG4gICAgbGV0IHRyYWNrQ2xpY2tFdmVudDogT2JzZXJ2YWJsZTxhbnk+ID0gRU1QVFk7XG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdHJhY2sgaXMgaG92ZXJlZFxuICAgIGxldCB0cmFja0hvdmVyZWRFdmVudDogT2JzZXJ2YWJsZTxhbnk+ID0gRU1QVFk7XG5cbiAgICAvLyBTZXQgdGhlIG1ldGhvZCB1c2VkIGZvciB0aGUgcG9pbnRlciBldmVudHMgb3B0aW9uXG4gICAgaWYgKHRoaXMuY21wLnBvaW50ZXJFdmVudHNNZXRob2QgPT09ICd2aWV3cG9ydCcpIHtcbiAgICAgIC8vIFBvaW50ZXIgZXZlbnRzIHVzaW5nIHRoZSB2aWV3cG9ydFxuICAgICAgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICAgIHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG5cbiAgICAgIC8vIEFjdGl2YXRlIHRoZSBwb2ludGVyIGV2ZW50cyBvZiB0aGUgdmlld3BvcnQgZGlyZWN0aXZlXG4gICAgICB0aGlzLmNtcC52aWV3cG9ydC5hY3RpdmF0ZVBvaW50ZXJFdmVudHModGhpcy5jbXAudmlld3BvcnRQcm9wYWdhdGVNb3VzZU1vdmUsIHRoaXMuZGVzdHJveWVkKTtcblxuICAgICAgLy8gU2V0IHN0cmVhbXNcbiAgICAgIHRodW1iRHJhZ0V2ZW50ID0gdGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZDtcbiAgICAgIHRyYWNrQ2xpY2tFdmVudCA9IHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQ7XG4gICAgICB0cmFja0hvdmVyZWRFdmVudCA9IHRoaXMuY21wLnZpZXdwb3J0LmhvdmVyZWQucGlwZShcbiAgICAgICAgLy8gQ2hlY2sgaWYgdHJhY2sgaXMgaG92ZXJlZFxuICAgICAgICBtYXAoKGU6IGFueSkgPT4gaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50cmFjay5jbGllbnRSZWN0KSksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgIC8vIEVuYWJsZSAvIGRpc2FibGUgdGV4dCBzZWxlY3Rpb25cbiAgICAgICAgdGFwKChob3ZlcmVkOiBib29sZWFuKSA9PiB0aGlzLmRvY3VtZW50Lm9uc2VsZWN0c3RhcnQgPSBob3ZlcmVkID8gKCkgPT4gZmFsc2UgOiBudWxsKVxuICAgICAgKTtcblxuICAgICAgdGhpcy5jbXAudmlld3BvcnQuY2xpY2tlZC5waXBlKFxuICAgICAgICB0YXAoKGU6IGFueSkgPT4ge1xuICAgICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgICBpZiAoaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50aHVtYi5jbGllbnRSZWN0KSkge1xuICAgICAgICAgICAgICB0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkLm5leHQoZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2l0aGluQm91bmRzKGUsIHRoaXMudHJhY2suY2xpZW50UmVjdCkpIHtcbiAgICAgICAgICAgICAgdGhpcy5jbXAuc2V0Q2xpY2tlZCh0cnVlKTtcbiAgICAgICAgICAgICAgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZC5uZXh0KGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmNtcC5zZXRDbGlja2VkKGZhbHNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpXG4gICAgICApLnN1YnNjcmliZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBQb2ludGVyIGV2ZW50cyBtZXRob2QgaXMgdXNpbmcgJ3Njcm9sbGJhcidcbiAgICAgIHRodW1iRHJhZ0V2ZW50ID0gdGhpcy50aHVtYi5jbGlja2VkO1xuICAgICAgdHJhY2tDbGlja0V2ZW50ID0gdGhpcy50cmFjay5jbGlja2VkO1xuICAgICAgdHJhY2tIb3ZlcmVkRXZlbnQgPSB0aGlzLnRyYWNrLmhvdmVyZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1lcmdlKFxuICAgICAgLy8gQWN0aXZhdGUgc2Nyb2xsYmFyIGhvdmVyZWQgZXZlbnRcbiAgICAgIHRyYWNrSG92ZXJlZEV2ZW50LnBpcGUodGFwKChlOiBib29sZWFuKSA9PiB0aGlzLnNldEhvdmVyZWQoZSkpKSxcbiAgICAgIC8vIEFjdGl2YXRlIHNjcm9sbGJhciB0aHVtYiBkcmFnIGV2ZW50XG4gICAgICB0aHVtYkRyYWdFdmVudC5waXBlKHN3aXRjaE1hcCgoZTogYW55KSA9PiB0aGlzLnRodW1iLmRyYWdnZWQoZSkpKSxcbiAgICAgIC8vIEFjdGl2YXRlIHNjcm9sbGJhciB0cmFjayBjbGljayBldmVudFxuICAgICAgdHJhY2tDbGlja0V2ZW50LnBpcGUoc3dpdGNoTWFwKChlOiBhbnkpID0+IHRoaXMudHJhY2sub25UcmFja0NsaWNrZWQoZSwgdGhpcy50aHVtYi5zaXplLCB0aGlzLnZpZXdwb3J0U2Nyb2xsU2l6ZSkpKVxuICAgICk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgLy8gQWN0aXZhdGUgcG9pbnRlciBldmVudHMgb24gRGVza3RvcCBvbmx5XG4gICAgICBpZiAoISh0aGlzLnBsYXRmb3JtLklPUyB8fCB0aGlzLnBsYXRmb3JtLkFORFJPSUQpICYmICF0aGlzLmNtcC5wb2ludGVyRXZlbnRzRGlzYWJsZWQpIHtcbiAgICAgICAgdGhpcy5hY3RpdmF0ZVBvaW50ZXJFdmVudHMoKS5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCkpLnN1YnNjcmliZSgpO1xuICAgICAgfVxuXG4gICAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGhvc3QgY29tcG9uZW50IGlzIHVwZGF0ZWRcbiAgICAgIGNvbnN0IHVwZGF0ZWQgPSB0aGlzLmNtcC51cGRhdGVkLnBpcGUodGFwKCgpID0+IHRoaXMub25VcGRhdGVkKCkpKTtcblxuICAgICAgLy8gVXBkYXRlIHNjcm9sbGJhciB0aHVtYiB3aGVuIHZpZXdwb3J0IGlzIHNjcm9sbGVkIGFuZCB3aGVuIHNjcm9sbGJhciBjb21wb25lbnQgaXMgdXBkYXRlZFxuICAgICAgbWVyZ2UodGhpcy5jbXAuc2Nyb2xsZWQsIHVwZGF0ZWQpLnBpcGUoXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLnRodW1iLnVwZGF0ZSgpKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKVxuICAgICAgKS5zdWJzY3JpYmUoKTtcblxuICAgICAgLy8gSW5pdGlhbGl6ZSBzY3JvbGxiYXJcbiAgICAgIGFzeW5jU2NoZWR1bGVyLnNjaGVkdWxlKCgpID0+IHRoaXMudGh1bWIudXBkYXRlKCksIDEwMCk7XG4gICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3llZC5uZXh0KCk7XG4gICAgdGhpcy5kZXN0cm95ZWQuY29tcGxldGUoKTtcblxuICAgIC8vIENsZWFuIHVwIHZpZXdwb3J0IHN0cmVhbXMgaWYgdXNlZFxuICAgIGlmICh0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkICYmIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQpIHtcbiAgICAgIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQuY29tcGxldGUoKTtcbiAgICAgIHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQuY29tcGxldGUoKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2V0SG92ZXJlZCh2YWx1ZTogYm9vbGVhbik6IHZvaWQ7XG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IG9uVXBkYXRlZCgpOiB2b2lkO1xufVxuIl19